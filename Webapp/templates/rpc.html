{% extends "base.html" %}

{% block title %}Home Page{% endblock %}

{% block style %}
    #filebrowser{

		min-width: 31%;
		max-width: 31%;
        float:left;
    }


    #analysis{

		min-width: 63%;
		max-width: 63%;
        float:right;

    }


    #toolselector{
        float:right;
    }



{% endblock %}

{% block rpc_analysis_nav %}
	active
{% endblock %}


{% block content %}
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <ul class=flashes>
            {% for message in messages %}
              <li>{{ message }}</li>
            {% endfor %}
            </ul>
        {% endif %}

    {% endwith %}



    <br>
	<div style="position:relative;">
		<div style="  position:absolute; top: 0; bottom: 0; left: 0; right: 0; margin: auto;">
			<form onsubmit="loading();" method="post" action="/">

				<div id="filebrowser" style="margin-left: 2%;">
	  				<div class="card" style="height: 13vh; margin-bottom: 1%;">
						<div class="card-header" style="background-color: rgb(171, 235, 198 );"><h4>RPC Analysis</h4></div>
						<div class="card-body"><p><i>Performs onchain analysis on a user specified JSON RPC endpoint.</i></p></div>
					</div>
					<div class="card">
						<div class="card-header" style="background-color: rgb(204, 209, 209);"><h4>Contract Browser</h4></div>
						<div class="card-body">			
							<div style="float:right; height: 100%; width: 100%; max-width: 100%;">

									<div style="margin-top: 1%;">
	
											<label style="float: left; font-weight: bold; width: 27%;" for="selectedTool">Analysis Tool:</label><br>
											<select style="width: 30%;"  name="selectedTool" id="selectedTool">
											    {% for tool in tools %}
											    	<option>{{tool}}</option>
											    {% endfor %}
											</select><br>
											


											<label style="float: left; font-weight: bold; width: 27%;" for="contract_add">Contract Address:</label><br>
											<input type="text" id="contract_add" name="contract_add" style="width: 90%;" value=""><br>

											<label style="float: left; font-weight: bold; width: 27%;" for="ip">IP:</label><br>
											<input type="text" id="ip" name="ip" style="width: 25%;"  value=""><br>

											<label style="float: left; font-weight: bold; width: 27%;" for="port">Port:</label><br>
											<input type="text" id="port" name="port" style="width: 10%;" value=""><br>

											<button type="button" class="btn" id="analyze" name="analyze" style="color: rgb(253, 254, 254); background-color: rgb(52, 152, 219); float: right;"  onclick="loading();analyze_contract();">Analyze</button>

									</div>


							</div>
						</div>
					</div>
				</div>

				<div id="analysis" style="margin-right: 2%;">
					<div class="card" id="analysis_card" style="height: 85vh; display: none;">
						<div class="card-header" style="background-color: rgb(210, 180, 222); "><h4>Analysis Results</h4></div>
						<div class="card-body" style="height: 100%;">
							<div id="loading" style="margin-top: auto; margin-bottom: auto;margin-left: auto; margin-right: auto; display: none;">
								<img src="static/loading.gif" alt="" />
							</div>
							<div id="results" style="height: 100%; width:100%; max-width: 100%; margin-left: auto; margin-right: auto;"><textarea style="resize: none; height: 90%; width: 100%; max-width: 100%;" id="results_out" readonly></textarea></div>
						</div>
					</div>
				</div>

			</form>
		</div>
	</div>





	<script>

		function analyze_contract() {
			var data = new FormData();
			data.append('analyze', document.getElementById('analyze').value);
			data.append('selectedTool', document.getElementById('selectedTool').value);
			data.append('contract_add', document.getElementById('contract_add').value);
			data.append('ip', document.getElementById('ip').value);
			data.append('port', document.getElementById('port').value);

			var output = document.getElementById('results_out');
			output.textContent = '';
			var xhr = new XMLHttpRequest();
			xhr.open('POST', '{{ url_for('rpc_analysis') }}', true);


			xhr.onerror = function (e) {
			  console.error(xhr.status);
			};

			xhr.onload = function() {

				if (xhr.status == 200) {
				   console.log(xhr.status);
				}else{
				    console.log(xhr.status);
				}

			};

			xhr.send(data);

			var position = 0;

			function handleNewData() {
				// the response text include the entire response so far
				// split the messages, then take the messages that haven't been handled yet
				// position tracks how many messages have been handled
				// messages end with a newline, so split will always show one extra empty message at the end
				//var messages = xhr.responseText.split('\n');
				var messages = xhr.responseText;
				output.textContent = messages;
				//messages = messages.split('\n');
				//messages.slice(position, -1).forEach(function(value) {

					// build and append a new item to a list to log all output
				//	var item = document.createElement('li');
				//	item.textContent = value;
				//	output.textContent = output.textContent + value +"<br>";
				//});
				position = messages.length - 1;
			}

			var timer;
			timer = setInterval(function() {
				// check the response for new data
				handleNewData();
				console.log('tick')
				// stop checking once the response has ended
				if (xhr.readyState == XMLHttpRequest.DONE) {
					clearInterval(timer);

				var x = document.getElementById("loading");
				x.style.display = "none";


				var v = document.getElementById("results");
				v.style.display = "block";
					}
			}, 1000);

			
		}

	</script>




	<script>
        function loading(){
			var x = document.getElementById("loading");
			  if (x.style.display === "none") {
				x.style.display = "block";
			  } else {
				x.style.display = "none";
			  }
			var z = document.getElementById("analysis_card");
			z.style.display = "block";

			var v = document.getElementById("results");
			v.style.display = "none";
   
        };
	</script>
	

	
{% endblock %}