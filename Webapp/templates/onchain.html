{% extends "base.html" %}

{% block title %}Home Page{% endblock %}

{% block style %}
    #filebrowser{
        width:47%;
		min-width: 47%;
		max-width: 47%;
		float: left;
    }


    #analysis{
        width:47%;
		min-width: 47%;
		max-width: 47%;
		float: right;

    }


    #toolselector{
        float:right;
    }



{% endblock %}

{% block onchain_analysis_nav %}
	active
{% endblock %}


{% block content %}
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <ul class=flashes>
            {% for message in messages %}
              <li>{{ message }}</li>
            {% endfor %}
            </ul>
        {% endif %}

    {% endwith %}

    <!-- Button trigger modal -->

    <br>
	<div style="position:relative;">
		<div style="  position:absolute; top: 0; bottom: 0; left: 0; right: 0; margin: auto;">
			<form onsubmit="loading();" method="post" action="/">
				<div id="filebrowser" style="margin-left: 2%;">
	  				<div class="card" style="height: 13vh; margin-bottom: 1%;">
						<div class="card-header" style="background-color: rgb(245, 203, 167 );"><h4>Onchain Analysis</h4></div>
						<div class="card-body"><p><i>Performs onchain analysis on Solidity contracts deployed to Ganache a personal Ethereum blockchain.</i></p></div>
					</div>


					<div class="card " style="; height: 70vh;">
						<div class="card-header" style="background-color: rgb(204, 209, 209);"><h4>Contract Browser</h4></div>
						<div class="card-body">
							
							<div style="float:left; width: 25%; max-width: 25%;">
								<div style="overflow-y: auto; overflow-x: hidden; height: 48vh;">
									<div class="btn-group-vertical" role="group" style="margin-top: 0.5%; width: 100%; max-width: 100%;"  aria-label="Vertical radio toggle button group">
										{% for key, value in files.items() %}
											<input type="radio" class="btn-check" name="vbtn-radio" id="vbtn-radio{{key}}" autocomplete="off" onclick="set_selected_file('{{key}}')" value="{{value[1]}}">
											<label class="btn btn-outline-secondary" for="vbtn-radio{{key}}">{{key}}</label>
										{% endfor %}
									</div>
								</div>
								<div style="margin-top: 10%;">

									    <button type="button" style="color: rgb(253, 254, 254); background-color: rgb(52, 152, 219); width: 100%; max-width: 100%;" class="btn" data-bs-toggle="modal" data-bs-target="#exampleModal">
									        Upload Contract
									    </button>
									    <button type="submit" style="color: rgb(253, 254, 254); background-color: rgb(231, 76, 60); width: 100%; max-width: 100%;" class="btn" id="delete" name="delete" disabled>
									        Delete Contract
									    </button>

								</div>
							</div>
							<div style="float:right; height: 100%; width: 73%; max-width: 73%;">

									<div style="height: 91%; width: 100%; max-width: 100%;" >
									    {% if contractcode %}
											<textarea style="resize: none; height: 100%; width: 100%; max-width: 100%;" name="contract_code" id="contract_code" readonly>{{contractcode}}</textarea>
										{% else %}
											<textarea style="resize: none; height: 100%; width: 100%; max-width: 100%;" name="contract_code" id="contract_code" readonly></textarea>
										{% endif %}
									    
									</div>
									<div style="height: 10%; margin-top: 1%;">
										<div style="float:left;">
											<button type="button" class="btn" id="edit" name="edit" style="color: rgb(253, 254, 254); background-color: rgb(52, 152, 219); display: inline-block;"  disabled>Edit</button>
											<button type="submit" class="btn" id="save" name="save" style="color: rgb(253, 254, 254); background-color: rgb(52, 152, 219); display: inline-block;" disabled>Save</button>
									        <button type="button" class="btn" id="analyze" name="analyze" style="color: rgb(253, 254, 254); background-color: rgb(52, 152, 219); display: inline-block;" disabled onclick="loading();analyze_contract();">Analyze</button>
										</div>


									    <div style="float:right; width: 40%; max-width: 40%;">
											<label style="display: inline-block;" for="selectedTool">Analysis Tool</label>
									        <select style="display: inline-block; width: 60%; max-width: 60%;" name="selectedTool" id="selectedTool">
									            {% for tool in tools %}
									            	<option>{{tool}}</option>
									            {% endfor %}
									        </select>
									    </div>
									</div>
							</div>
						</div>
					</div>
				</div>
			        <input type="hidden" value="" name="file_selected" id="file_selected">


				<div id="analysis" style="margin-right: 2%;">
					<div class="card" id="analysis_card" style="height: 85vh; display: none;">
						<div class="card-header" style="background-color: rgb(210, 180, 222); "><h4>Analysis Results</h4></div>
						<div class="card-body" style="height: 100%;">

							<div id="loading" style="margin-top: auto; margin-bottom: auto;margin-left: auto; margin-right: auto; display: none;">
								<img src="static/loading.gif" alt="" />
							</div>
							<div id="results" style="height: 100%; width:100%; max-width: 100%; margin-left: auto; margin-right: auto;"><textarea style="resize: none; height: 90%; width: 100%; max-width: 100%;" id="results_out" readonly></textarea></div>
						</div>
					</div>

				</div>

			</form>
		</div>
	</div>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Upload Contract</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
                <form action="/upload" method=post enctype=multipart/form-data>
                    <input type=file name=file>
                    <input type=submit value=Upload>
                </form>
          </div>
        </div>
      </div>



	<script>

		function analyze_contract() {
			var data = new FormData();
			data.append('analyze', document.getElementById('analyze').value);
			data.append('selectedTool', document.getElementById('selectedTool').value);
			data.append('file_selected', document.getElementById('file_selected').value);
			data.append('contract_code', document.getElementById('contract_code').value);
		

			var output = document.getElementById('results_out');
			output.textContent = '';
			var xhr = new XMLHttpRequest();
			xhr.open('POST', '{{ url_for('on_chain_analyze') }}', true);


			xhr.onerror = function (e) {
			  console.error(xhr.status);
			};

			xhr.onload = function() {

				if (xhr.status == 200) {
				   console.log(xhr.status);
				}else{
				    console.log(xhr.status);
				}

			};

			xhr.send(data);

			var position = 0;

			function handleNewData() {
				// the response text include the entire response so far
				// split the messages, then take the messages that haven't been handled yet
				// position tracks how many messages have been handled
				// messages end with a newline, so split will always show one extra empty message at the end
				//var messages = xhr.responseText.split('\n');
				var messages = xhr.responseText;
				output.textContent = messages;
				//messages = messages.split('\n');
				//messages.slice(position, -1).forEach(function(value) {

					// build and append a new item to a list to log all output
				//	var item = document.createElement('li');
				//	item.textContent = value;
				//	output.textContent = output.textContent + value +"<br>";
				//});
				position = messages.length - 1;
			}

			var timer;
			timer = setInterval(function() {
				// check the response for new data
				handleNewData();
				console.log('tick')
				// stop checking once the response has ended
				if (xhr.readyState == XMLHttpRequest.DONE) {
					clearInterval(timer);

				var x = document.getElementById("loading");
				x.style.display = "none";


				var v = document.getElementById("results");
				v.style.display = "block";
					}
			}, 1000);






			
		}

	</script>


    <script type="text/javascript">
        function handleUserAnswer(e){
            var el = e.target || e.srcElement;
            document.getElementById('contract_code').value = el.value;
        }
        var radios = document.getElementsByTagName('input');
        for(var i = 0; i<radios.length; i++){
            var r = radios[i];
            if(r.getAttribute('name') == 'vbtn-radio'){
                if(r.addEventListener){
                    r.addEventListener('change',handleUserAnswer);
                }else if(r.attachEvent){
                    r.attachEvent('onchange',handleUserAnswer);
                }else{
                    r.onChange = handleUserAnswer;
                }
            }
        }
    </script>

    <script>
        function set_selected_file(x){
            const a = document.getElementById("file_selected").value = x;
            a.value = x;
        };
    </script>

	<script>
		var edit = document.getElementById("edit");
		  edit.onclick= function () {
			document.getElementById("save").removeAttribute("disabled");
			document.getElementById("contract_code").removeAttribute("readonly");
			document.getElementById("edit").setAttribute("disabled", "");
			document.getElementById("analyze").setAttribute("disabled", "");
		  };
	</script>

	<script>
		var inputElems = document.getElementsByClassName("btn-check");
		for (var i = inputElems.length - 1; i >= 0; --i) {
		  var elem = inputElems[i];
		  elem.onchange = function () {
			document.getElementById("edit").removeAttribute("disabled");
			document.getElementById("analyze").removeAttribute("disabled");
			document.getElementById("delete").removeAttribute("disabled");
			document.getElementById("contract_code").setAttribute("readonly", "");
			document.getElementById("save").setAttribute("disabled", "");
		  };
		}
	</script>

	<script>
        function loading(){
			var x = document.getElementById("loading");
			  if (x.style.display === "none") {
				x.style.display = "block";
			  } else {
				x.style.display = "none";
			  }
			var z = document.getElementById("analysis_card");
			z.style.display = "block";

			var v = document.getElementById("results");
			v.style.display = "none";
   
        };
	</script>
	
    {% if selectedcontract %}
	<script>
		var selected = document.getElementById("vbtn-radio{{selectedcontract}}");
		selected.checked= true;
		document.getElementById("edit").removeAttribute("disabled");
		document.getElementById("analyze").removeAttribute("disabled");
		document.getElementById("delete").removeAttribute("disabled");


	</script>
    {% endif %}

    {% if selectedTool %}
	<script>
		document.getElementById("selectedTool").value = "{{selectedTool}}";

	</script>
    {% endif %}
	
{% endblock %}